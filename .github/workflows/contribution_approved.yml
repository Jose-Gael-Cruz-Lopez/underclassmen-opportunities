name: Contribution Approved

on:
  issues:
    types: [labeled]

concurrency:
  group: add_opportunity
  cancel-in-progress: false

jobs:
  process-contribution:
    # Only run for non-auto_extract issues (manual submissions)
    if: github.event.label.name == 'approved' && !contains(github.event.issue.labels.*.name, 'auto_extract') && contains(github.event.issue.labels.*.name, 'approved')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Process contribution
        id: process
        run: |
          python .github/scripts/contribution_approved.py "${{ github.event_path }}"

      - name: Update READMEs
        id: update_readme
        run: |
          python .github/scripts/update_readmes.py

      - name: Configure Git
        run: |
          git config user.name "${{ steps.process.outputs.contributor_name }}"
          git config user.email "${{ steps.process.outputs.contributor_email }}"

      - name: Commit and push changes
        run: |
          git add .github/scripts/listings.json README.md
          git commit -m "${{ steps.process.outputs.commit_message }}"
          # Rebase and retry push up to 3 times
          for i in 1 2 3; do
            git fetch origin main && git rebase origin/main && git push origin main && break
            echo "Push attempt $i failed, retrying..."
            sleep 2
          done

      - name: Close issue with success message
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: '✅ Your contribution has been added to the repository! Thank you for contributing!\n\nYour changes should now be visible in the README.'
            });
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              state: 'closed'
            });

      - name: Comment on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: '❌ There was an error processing your contribution. A maintainer will review this issue.\n\nError details: ${{ steps.process.outputs.error_message || steps.update_readme.outputs.error_message || "Unknown error" }}'
            });
