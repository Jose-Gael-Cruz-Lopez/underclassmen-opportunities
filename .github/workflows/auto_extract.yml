name: Auto-Extract Opportunity

on:
  issues:
    types: [labeled]

jobs:
  extract:
    if: github.event.label.name == 'approved' && contains(github.event.issue.labels.*.name, 'auto_extract')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install requests beautifulsoup4 openai

      - name: Extract opportunity details
        id: extract
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GITHUB_EVENT_PATH: ${{ github.event_path }}
        run: |
          python .github/scripts/auto_extract.py "$GITHUB_EVENT_PATH"

      - name: Update README
        run: |
          python .github/scripts/update_readmes.py

      - name: Commit changes
        run: |
          git config user.name "${{ steps.extract.outputs.contributor_name }}"
          git config user.email "${{ steps.extract.outputs.contributor_email }}"
          git add .github/scripts/listings.json README.md
          git commit -m "${{ steps.extract.outputs.commit_message }}"
          git push origin main

      - name: Comment on issue
        uses: actions/github-script@v7
        with:
          script: |
            const extractedData = JSON.parse('${{ steps.extract.outputs.extracted_data }}' || '{}');
            const warning = '${{ steps.extract.outputs.warning }}';

            let body = `## Opportunity Added Successfully!\n\n`;
            body += `**Company:** ${extractedData.company_name || 'Unknown'}\n`;
            body += `**Role:** ${extractedData.title || 'Unknown'}\n`;
            body += `**Category:** ${extractedData.category || 'Unknown'}\n`;
            body += `**Location:** ${(extractedData.locations || []).join(', ')}\n`;
            body += `**Season:** ${extractedData.season || 'Unknown'}\n\n`;

            if (warning) {
              body += `> **Note:** ${warning}\n\n`;
            }

            body += `The opportunity has been added to the README. Thank you for contributing!`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });

      - name: Close issue
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              state: 'closed'
            });

      - name: Handle failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const errorMessage = '${{ steps.extract.outputs.error_message }}' || 'An unknown error occurred during extraction.';

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## Extraction Failed\n\n${errorMessage}\n\nPlease try using the **Quick Add** or **New Opportunity** template instead.`
            });
